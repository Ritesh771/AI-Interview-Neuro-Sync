"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("./index-N3n6WSly.cjs"),v=require("./chunk-K5TMEGOR-CjzheANK.cjs");require("./chunk-3MEZQQ2J-Bai2OMk0.cjs");const I=require("./chunk-SDMTFDEM-DMM8sQyi.cjs"),f=require("./chunk-6U6BYUHV-h-2X1uK0.cjs"),k=require("./chunk-MVFOLHBC-C85clPX2.cjs"),u=require("./chunk-WG46WHJF-D0x9jAhS.cjs");c.y();c.y();var x=class{constructor(){this.keys=["@"],this.input=null,this.mentions=[]}setInput(n){this.event=n,this.input=n.target,this.key=n.data}getMentions(n,t=[]){return t.length>0&&(this.mentions=t),this.mentions.filter(e=>((i,s)=>s.includes(i.name))(e,n))}setMentions(n){this.mentions=n}addMention(n){this.mentions.some(t=>t.userId===n.userId)||this.mentions.push(n)}clearMentions(){this.mentions=[]}getSelectionPosition(){var n;let t=this.getSelectionStart(),e=this.getLastKeyBeforeCaret(t);return{start:((n=e==null?void 0:e.keyIndex)!=null?n:-1)+1,end:t}}getSelectionStart(){var n;return(n=this.input)==null?void 0:n.selectionStart}setCaretPosition(n){this.input.selectionEnd=n}getValue(){var n;return(n=this.input)==null?void 0:n.value}setValue(n){this.input.value=n}getLastKeyBeforeCaret(n){let[t]=this.keys.map(e=>({key:e,keyIndex:this.getValue().lastIndexOf(e,n-1)})).sort((e,i)=>i.keyIndex-e.keyIndex);return t}searchMention(n,t){return t!==-1?this.getValue().substring(t+1,n):null}isDeletion(){return this.event.inputType==="deleteContentBackward"||this.event.inputType==="deleteContentForward"||this.event.inputType==="deleteWordBackward"}insertMention(n,t,e){if(this.isDeletion())return;let{id:i,name:s}=e,o=`${this.getValue().slice(0,n)+s} ${this.getValue().slice(t,this.getValue().length)}`;this.setValue(o),this.input.focus(),this.addMention({userId:i,name:s}),this.setCaretPosition(n+s.length+1)}};c.y();var h={SHOW:"show",HIDE:"hide"},L={action:h.HIDE,mentions:[],findDigitParticipant:!1},E=(n,t,e)=>{var i,s;let o=[];if(o=e==null?void 0:e.filter(a=>a==null?void 0:a.email),n.length>0&&(o=o.filter(a=>(a==null?void 0:a.name.toLowerCase().search(n.toLowerCase()))!==-1),n===((s=(i=o[0])==null?void 0:i.name)==null?void 0:s.toLowerCase()))){let a=b(o,t);return{action:h.HIDE,mentions:a,findDigitParticipant:!0}}if(!((o==null?void 0:o.length)>0))return L;let l=b(o,t);return{action:h.SHOW,mentions:l,findDigitParticipant:!1}},b=(n,t)=>n.map(e=>({id:e.id,name:e.name,avatar:e.avatar,email:e.email,position:t})),H={matchParticipant:(n,t,e)=>E(n,t,e)},_=k.D(u.C),S=[_.styles,I.s];exports.CommentsCommentInput=class extends _{constructor(){super(),this.pinCoordinates=null,this.autoCompleteHandler=new x,this.addAtSymbolInCaretPosition=()=>{let t=this.shadowRoot.querySelector(".comments__input__textarea"),e=new InputEvent("input",{bubbles:!0,cancelable:!0});Object.defineProperty(e,"data",{value:"@",writable:!0}),t.dispatchEvent(e)},this.getCommentInput=()=>this.shadowRoot.querySelector(".comments__input__textarea"),this.userMentionedByTextInput=t=>{this.mentionList=[];let e={detail:c.A({},t[0])};this.insertMention(e)},this.buttonAtSymbol=()=>{var t;let e=this.autoCompleteHandler.getSelectionStart(),i=this.autoCompleteHandler.getValue();this.autoCompleteHandler.setValue(`${i.slice(0,e)}@${i.slice(e,i.length)}`),e+=1;let s=this.autoCompleteHandler.getLastKeyBeforeCaret(e),o=(t=s==null?void 0:s.keyIndex)!=null?t:-1,l=this.autoCompleteHandler.searchMention(e,o),a={start:o+1,end:e};return{searchText:l,position:a}},this.focusInput=()=>{this.getCommentInput().focus()},this.handleInput=t=>{var e,i;((e=this.commentInput)==null?void 0:e.value.length)===0?this.btnActive=!1:this.btnActive=!0,this.autoCompleteHandler.setInput(t);let s=this.autoCompleteHandler.getSelectionStart(),o=this.autoCompleteHandler.getLastKeyBeforeCaret(s),l=(i=o==null?void 0:o.keyIndex)!=null?i:-1;if(s===-1)return;let a=this.autoCompleteHandler.searchMention(s,l),r=this.autoCompleteHandler.getSelectionPosition(),g=t.data==="@"&&l===-1,y=t.data==="@"&&s-1!==l;if(g||y){let p=this.buttonAtSymbol();a=p.searchText,r=p.position}if(a===null){this.mentionList=[];return}let{action:d,mentions:m,findDigitParticipant:C}=H.matchParticipant(a,r,this.participantsList);if(C){this.userMentionedByTextInput(m);return}d==="show"&&(this.mentionList=m),d==="hide"&&(this.mentionList=[])},this.insertMention=t=>{let{id:e,name:i,avatar:s,email:o,position:l}=t.detail;this.autoCompleteHandler.insertMention(l.start,l.end,{id:e,name:i,avatar:s,email:o}),this.mentionList=[],this.updateHeight()},this.sendEnter=t=>{var e;if(t.key!=="Escape"&&t.stopImmediatePropagation(),t.key==="Enter"&&!t.shiftKey&&t.preventDefault(),t.key!=="Enter"||t.shiftKey||((e=this.mentionList)==null?void 0:e.length)>0)return;let i=this.commentInput,s=i.value.trim();if(!s)return;let o=this.autoCompleteHandler.getMentions(s);this.emitEvent(this.eventType,{text:s,mentions:o,position:this.pinCoordinates},{composed:!1,bubbles:!1}),i.value="",this.sendBtn.disabled=!0,this.updateHeight()},this.closeEditMode=()=>{this.emitEvent("close-edit-mode",{},{composed:!1,bubbles:!1}),this.hideInput=!0},this.onTextareaFocus=()=>{let t=this.optionsContainer,e=this.horizontalRule,i=this.commentInput;t.classList.add("active-textarea"),e.classList.add("comments__input__divisor"),i.classList.add("active-textarea")},this.onTextareaLoseFocus=t=>{var e,i;let s=(i=(e=t.explicitOriginalTarget)==null?void 0:e.parentNode)==null?void 0:i.host,o=this.mentionButton;if(o===t.explicitOriginalTarget||o===t.relatedTarget)return;if(this.closeButton.contains(s)||this.closeButton.contains(t.explicitOriginalTarget)||this.closeButton.contains(t.relatedTarget)){this.cancelComment();return}if(!this.shadowRoot.contains(t.target))return;let l=this.optionsContainer,a=this.horizontalRule,r=this.commentInput;r.value.length||(l.classList.remove("active-textarea"),a.classList.remove("comments__input__divisor"),r.classList.remove("active-textarea"))},this.cancelComment=()=>{document.body.dispatchEvent(new KeyboardEvent("keyup",{key:"Escape"}))},this.commentInputEditableOptions=()=>{var t;if(this.editable)return u.Vt`
      <button
        id="close"
        @click=${this.closeEditMode}
        class="icon-button icon-button--medium icon-button--clickable comments__input__button comments__input__close-button"
      >
        <superviz-icon name="close" size="sm"></superviz-icon>
      </button>
      <button
        id="confirm"
        class="icon-button icon-button--medium icon-button--clickable icon-button--no-hover comments__input__button comments__input__send-button"
        disabled
        @click=${this.send}
      >
        <superviz-icon
          color=${(t=this.sendBtn)!=null&&t.disabled||!this.sendBtn?"black":"white"}
          name="check"
          size="sm"
        ></superviz-icon>
      </button>
    `},this.commentInputOptions=()=>{var t;if(!this.editable)return u.Vt`
      <button
        class="icon-button icon-button--medium icon-button--clickable comments__input__button comments__input__close-button align-send-btn"
        @click=${this.cancelComment}
      >
        <superviz-icon name="close" size="sm"></superviz-icon>
      </button>
      <button
        class="comments__input__button comments__input__send-button align-send-btn"
        disabled
        @click=${this.send}
      >
        <superviz-icon
          color=${(t=this.sendBtn)!=null&&t.disabled||!this.sendBtn?"black":"white"}
          name="line-arrow-right"
          size="sm"
        ></superviz-icon>
      </button>
    `},this.btnActive=!1,this.text="",this.mentionList=[],this.mentions=[],this.mode="readonly"}get commentInput(){return this.shadowRoot.querySelector(".comments__input__textarea")}get mentionButton(){return this.shadowRoot.querySelector(".mention-button")}get sendBtn(){return this.shadowRoot.querySelector(".comments__input__send-button")}get optionsContainer(){return this.shadowRoot.querySelector(".comments__input__options")}get horizontalRule(){return this.shadowRoot.querySelector(".sv-hr")}get closeButton(){return this.shadowRoot.querySelector(".comments__input__close-button")}connectedCallback(){super.connectedCallback(),["create-annotation","create-comment"].includes(this.eventType)&&this.addEventListener("keyup",this.sendEnter)}disconnectedCallback(){if(super.disconnectedCallback(),!["create-annotation","create-comment"].includes(this.eventType))return;let t=this.getCommentInput();this.removeEventListener("keyup",this.sendEnter),t.removeEventListener("keydown",this.sendEnter),t.removeEventListener("click",this.focusInput),t.addEventListener("input",this.handleInput)}firstUpdated(t){this.updateComplete.then(()=>{this.emitEvent("comment-input-ready",{},{composed:!1,bubbles:!1});let e=this.getCommentInput();if(e&&(e.addEventListener("input",this.handleInput),e.addEventListener("click",this.focusInput),e.addEventListener("keydown",this.sendEnter)),this.text.length>0){let i=this.participantsList.map(({id:s,name:o})=>({userId:s,name:o}));this.mentions=this.autoCompleteHandler.getMentions(this.text,i),this.autoCompleteHandler.setMentions(this.mentions)}this.editable&&this.focusInput(),f.n.call(this,["comments"])})}updated(t){if(t.has("mode")&&this.mode==="editable"&&(this.focusInput(),this.updateHeight(),this.sendBtn.disabled=!1,this.btnActive=!0),t.has("text")&&this.text.length>0){let e=this.commentInput;e.value=this.text,this.updateHeight()}t.has("btnActive")&&(this.sendBtn.disabled=!this.btnActive)}updateHeight(){let t=this.commentInput;t.style.height="40px";let e=t.scrollHeight+14;e===47&&(e=40),t.style.height=`${e}px`,this.sendBtn.disabled=!(t.value.length>0)}send(t){var e;if(t.preventDefault(),((e=this.mentionList)==null?void 0:e.length)>0)return;let i=this.commentInput,s=i.value,o=this.autoCompleteHandler.getMentions(s);this.emitEvent(this.eventType,{text:s,mentions:o,position:this.pinCoordinates},{composed:!1,bubbles:!1}),i.value="",this.sendBtn.disabled=!0,this.updateHeight()}render(){var t;let e={comments__input__textarea:!0,"fixed-width":this.eventType==="create-annotation"},i={comments__input:!0,"comments__input--editable":this.editable,"hide-input":this.hideInput};return u.Vt`
      <div class="${v.u(i)}">
        <textarea
          id="comments__input__textarea"
          class=${v.u(e)}
          placeholder=${(t=this.placeholder)!=null?t:"Add comment..."}
          @input=${this.updateHeight}
          @focus=${this.onTextareaFocus}
          @blur=${this.onTextareaLoseFocus}
          spellcheck="false"
        ></textarea>
        <superviz-comments-mention-list
          .participants=${this.mentionList}
          @participant-selected=${this.insertMention}
        ></superviz-comments-mention-list>
        <div class="sv-hr"></div>
        <div class="comments__input__options">
          <button
            @click=${this.addAtSymbolInCaretPosition}
            class="mention-button icon-button icon-button--medium icon-button--clickable"
          >
            <superviz-icon name="mention" size="sm"></superviz-icon>
          </button>
          <div class="comment-input-options">
            ${this.commentInputOptions()} ${this.commentInputEditableOptions()}
          </div>
        </div>
      </div>
    `}};exports.CommentsCommentInput.styles=S,exports.CommentsCommentInput.properties={eventType:{type:String},text:{type:String},btnActive:{type:Boolean},editable:{type:Boolean},placeholder:{type:String},mentions:{type:Array},mentionList:{type:Object},participantsList:{type:Object},hideInput:{type:Boolean},mode:{type:String}},exports.CommentsCommentInput=c.F([u.ts("superviz-comments-comment-input")],exports.CommentsCommentInput);
